#!/usr/bin/env bash
#MISE description="Install packed plugin into OpenCode cache (production-like test)"
set -euo pipefail

PLUGIN_LOCAL_FILE="${HOME}/.config/opencode/plugin/opencode-synced-local.ts"
CACHE_DIR="${HOME}/.cache/opencode"
PACKAGE_DIR="$(pwd)"
VERSION="$(node -p "require('./package.json').version")"

if [ -f "${PLUGIN_LOCAL_FILE}" ]; then
  rm -f "${PLUGIN_LOCAL_FILE}"
fi

TARBALL="$(npm pack | tail -n 1)"

rm -rf "${CACHE_DIR}/node_modules/opencode-synced"

if [ -f "${CACHE_DIR}/package.json" ]; then
  python - <<PY
import json, re
from pathlib import Path
version = "${VERSION}"
path = Path("${CACHE_DIR}") / "package.json"
text = path.read_text()
deps = dict(re.findall(r'\"([^\\\"]+)\"\\s*:\\s*\"([^\\\"]+)\"', text))
deps["opencode-synced"] = version
path.write_text(json.dumps({"dependencies": deps}, indent=2) + "\\n")
PY
fi

(cd "${CACHE_DIR}" && npm install --no-save "${PACKAGE_DIR}/${TARBALL}")

echo "Installed ${TARBALL} (${VERSION}) into ${CACHE_DIR}"
